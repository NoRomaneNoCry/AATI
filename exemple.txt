#include <stdio.h>
#include <stdlib.h>
#include <assert.h>
#include <opencv/cv.h>
#include <opencv/highgui.h>

int main (int argc, char *argv[])
{
	double a[9]={1,0,-1,2,0,-2,1,0,-1};
	double b[9]={1,2,1,0,0,0,-1,-2,-1};
 
	IplImage* img=cvLoadImage(argv[1], 0);
	if(!img){
		printf("could not load image file: %s\n",argv[1]);
		exit(0);
	}	
	IplImage* dst=cvCreateImage(cvGetSize(img),IPL_DEPTH_64F,1);
	IplImage* dst1=cvCreateImage(cvGetSize(img),IPL_DEPTH_64F,1);
	IplImage* dst2=cvCreateImage(cvGetSize(img),IPL_DEPTH_64F,1);
	IplImage* dst_f=cvCreateImage(cvGetSize(img),IPL_DEPTH_8U,1);
 
 
	CvMat k1 = cvMat(3,3,CV_32FC1,a);
	CvMat k2 = cvMat(3,3,CV_32FC1,b);
 
	cvFilter2D( img ,dst1, &k1,cvPoint(-1,-1));
	cvFilter2D( img ,dst2, &k2,cvPoint(-1,-1));
 
	cvPow(dst1,dst1,2.0);
	cvPow(dst2,dst2,2.0);
	cvAdd(dst1,dst2,dst,NULL);
	cvPow(dst,dst,0.5);
	cvConvert(dst,dst_f);
	cvThreshold(dst_f,dst_f,127,255,CV_THRESH_BINARY);
 
	cvNamedWindow("mainWin", CV_WINDOW_AUTOSIZE);
	cvMoveWindow("mainWin", 100, 100);
	cvShowImage("mainWin",img);
 
	cvNamedWindow("result", CV_WINDOW_AUTOSIZE);
	cvMoveWindow("result", 100, 100);
	cvShowImage("result",dst);
 
    cvWaitKey(0);
 
	cvReleaseImage(&img);
	cvReleaseImage(&dst_f);
	return 0;
}